<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è²©å£²å£«1ç´šãƒãƒ¼ãƒãƒ£ãƒ«æ¨¡è©¦ â€“ å•é¡Œãƒ‡ãƒ¼ã‚¿åŸ‹è¾¼ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
    .quiz-option { transition: all .2s ease-in-out; }
    .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
    .correct { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46; }
    .incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b; }
    .explanation-box { animation: fadeIn .5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-retry { background-color: #f97316; color: white; }
    .btn-retry:hover { background-color: #ea580c; }
    .btn-comprehensive { background: linear-gradient(to right, #6d28d9, #4f46e5); color: white; }
    .btn-comprehensive:hover { background: linear-gradient(to right, #5b21b6, #4338ca); }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

<div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8"></div>

<script>
// --- å•é¡Œãƒ‡ãƒ¼ã‚¿ ---
// ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
const quizDataOriginal = {
 "è²©å£²ãƒ»çµŒå–¶ç®¡ç† (é¸æŠå¼)": [
    { "type": "multiple-choice", "question": "å•é¡Œè§£æ±ºã®ãŸã‚ã®æ•™è‚²æ–¹æ³•ã®ä¸€ã¤ã§ã‚ã‚‹ [ ] ã¨ã¯å¤šãã®è·å ´ã§èµ·ã“ã‚Šã†ã‚‹ã‚ˆã†ãªæ¡ˆä»¶ã‚’çš„ç¢ºã‹ã¤è¿…é€Ÿã«ç²¾åº¦é«˜ãå‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã‹ã‚’æ¸¬ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¼”ç¿’ã®ã“ã¨ã§ã‚ã‚‹ã€‚", "options": ["ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£ãƒ¡ã‚½ãƒƒãƒ‰", "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ³•", "ã‚¤ãƒ³ãƒã‚¹ã‚±ãƒƒãƒˆæ³•", "ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚²ãƒ¼ãƒ "], "answer": "ã‚¤ãƒ³ãƒã‚¹ã‚±ãƒƒãƒˆæ³•", "explanation": "ã‚¤ãƒ³ãƒã‚¹ã‚±ãƒƒãƒˆæ³•ã¯ã€å—è¬›è€…ã‚’æ¶ç©ºã®å½¹è·è€…ã«è¨­å®šã—ã€æœªå‡¦ç†ã®æ¡ˆä»¶ãŒæºœã¾ã£ãŸæ›¸é¡ç®±ï¼ˆã‚¤ãƒ³ãƒã‚¹ã‚±ãƒƒãƒˆï¼‰ã‚’æ¸¡ã—ã¦ã€åˆ¶é™æ™‚é–“å†…ã«æ¡ˆä»¶ã‚’å‡¦ç†ã•ã›ã‚‹æ¼”ç¿’ã§ã™ã€‚å„ªå…ˆé †ä½ä»˜ã‘ã€æƒ…å ±åˆ†æã€æ„æ€æ±ºå®šã€æŒ‡ç¤ºãƒ»ä¼é”èƒ½åŠ›ãªã©ã€ç®¡ç†è€…ã«æ±‚ã‚ã‚‰ã‚Œã‚‹ç·åˆçš„ãªå•é¡Œè§£æ±ºèƒ½åŠ›ã‚’è©•ä¾¡ãƒ»è‚²æˆã™ã‚‹ãŸã‚ã«ç”¨ã„ã‚‰ã‚Œã¾ã™ã€‚" },
    { "type": "multiple-choice", "question": "ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹å–å¼•ã¯ã€ãƒªãƒ¼ã‚¹è³‡ç”£ã®æ‰€æœ‰æ¨©ãŒå€Ÿã‚Šæ‰‹ã«ç§»è»¢ã™ã‚‹ã‹ã©ã†ã‹ã§ã€[ ] å–å¼•ã¨æ‰€æœ‰æ¨©ç§»è»¢å¤–ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹å–å¼•ã«åˆ†é¡ã•ã‚Œã‚‹ã€‚", "options": ["ãƒ¬ãƒ³ã‚¿ãƒ«å¥‘ç´„", "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒªãƒ¼ã‚¹", "ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒªãƒ¼ã‚¹", "æ‰€æœ‰æ¨©ç§»è»¢ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹"], "answer": "æ‰€æœ‰æ¨©ç§»è»¢ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹", "explanation": "ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹ã¯ã€ä¸­é€”è§£ç´„ä¸èƒ½ã§ã€ç‰©ä»¶ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹åˆ©ç›Šã‚’å®Ÿè³ªçš„ã«äº«å—ã—ã€ç¶­æŒç®¡ç†ã‚³ã‚¹ãƒˆã‚‚è² æ‹…ã™ã‚‹ã€å£²è²·ã«è¿‘ã„å–å¼•ã§ã™ã€‚ãã®ä¸­ã§ã€ãƒªãƒ¼ã‚¹æœŸé–“æº€äº†å¾Œã«æ‰€æœ‰æ¨©ãŒç§»è»¢ã™ã‚‹å¥‘ç´„ã‚’ã€Œæ‰€æœ‰æ¨©ç§»è»¢ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹ã€ã€ç§»è»¢ã—ãªã„ã‚‚ã®ã‚’ã€Œæ‰€æœ‰æ¨©ç§»è»¢å¤–ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ãƒªãƒ¼ã‚¹ã€ã¨åŒºåˆ¥ã—ã¾ã™ã€‚" },
  ],
  "è²©å£²ãƒ»çµŒå–¶ç®¡ç† (è¨˜è¿°å¼)": [
    { "type": "fill-in-the-blank", "question": "å¾“æ¥­å“¡ç®¡ç†è·èƒ½ã®å®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹ã¯J.H.ãƒ•ã‚¡ãƒ¨ãƒ¼ãƒ«ã«ã‚ˆã‚‹ã¨æ¬¡ã®é †ã¨ãªã£ã¦ã„ã‚‹ã€‚â‘ è¨ˆç”»ã€â‘¡[]ã€â‘¢å‹•æ©Ÿã¥ã‘ã€â‘£æŒ‡ä»¤ã€â‘¤èª¿æ•´ã€â‘¥çµ±åˆ¶", "answer": "çµ„ç¹”åŒ–", "explanation": "çµŒå–¶ç®¡ç†ã®çˆ¶ã¨å‘¼ã°ã‚Œã‚‹ãƒ•ã‚¡ãƒ¨ãƒ¼ãƒ«ã¯ã€ç®¡ç†æ´»å‹•ã‚’â‘ è¨ˆç”»(Plan)â†’â‘¡çµ„ç¹”åŒ–(Organize)â†’â‘¢æŒ‡ä»¤(Command)â†’â‘£èª¿æ•´(Coordinate)â†’â‘¤çµ±åˆ¶(Control)ã®5ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹ã«åˆ†é¡ã—ã¾ã—ãŸã€‚å‹•æ©Ÿã¥ã‘ã¯ã€ç¾ä»£ã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆè«–ã§æŒ‡ä»¤ã®ä¸­ã«å«ã¾ã‚Œã‚‹è¦ç´ ã¨ã—ã¦é‡è¦è¦–ã•ã‚Œã¦ã„ã¾ã™ã€‚" },
    { "type": "fill-in-the-blank", "question": "æ—¥æœ¬ã®çµ„ç¹”é‹å–¶ã®ç‰¹è³ªã§ã‚ã‚‹ [] ã¨é›†å›£ä¸»ç¾©ã‚’åŸºç›¤ã¨ã—ã¦çµŒå–¶çµ„ç¹”å†…ã§ç™ºé”ã—ã¦ããŸã®ã¯å°é›†å›£æ´»å‹•ã§ã‚ã‚‹ã€‚", "answer": "ãƒœãƒˆãƒ ã‚¢ãƒƒãƒ—æ–¹å¼", "explanation": "ãƒœãƒˆãƒ ã‚¢ãƒƒãƒ—æ–¹å¼ã¨ã¯ã€ç¾å ´ã®å¾“æ¥­å“¡ã‹ã‚‰ã®ææ¡ˆã‚„æ„è¦‹ã‚’å¸ã„ä¸Šã’ã¦çµŒå–¶å±¤ã®æ„æ€æ±ºå®šã«åæ˜ ã•ã›ã‚‹ç®¡ç†æ–¹å¼ã§ã™ã€‚QCã‚µãƒ¼ã‚¯ãƒ«ã«ä»£è¡¨ã•ã‚Œã‚‹å°é›†å›£æ´»å‹•ã¯ã€ã“ã®ãƒœãƒˆãƒ ã‚¢ãƒƒãƒ—æ–¹å¼ã¨ã€é›†å›£ã®å’Œã‚’é‡ã‚“ã˜ã‚‹æ—¥æœ¬çš„ãªçµ„ç¹”æ–‡åŒ–ã‚’èƒŒæ™¯ã«ç™ºå±•ã—ã¾ã—ãŸã€‚" }
  ],
    "å°å£²æ¥­ã®é¡å‹ (é¸æŠå¼)": [],
    "å°å£²æ¥­ã®é¡å‹ (è¨˜è¿°å¼)": [],
    "ãƒãƒ¼ãƒãƒ£ãƒ³ãƒ€ã‚¤ã‚¸ãƒ³ã‚° (é¸æŠå¼)": [],
    "ãƒãƒ¼ãƒãƒ£ãƒ³ãƒ€ã‚¤ã‚¸ãƒ³ã‚° (è¨˜è¿°å¼)": [],
    "ã‚¹ãƒˆã‚¢ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (é¸æŠå¼)": [],
    "ã‚¹ãƒˆã‚¢ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (è¨˜è¿°å¼)": [],
    "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° (é¸æŠå¼)": [],
    "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° (è¨˜è¿°å¼)": []
};
// -------------------- ã“ã“ã¾ã§ --------------------

// ä»¥é™ã¯ã‚¢ãƒ—ãƒªæœ¬ä½“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
const genreColors = {
    "å°å£²æ¥­ã®é¡å‹": 'border-indigo-500',
    "ãƒãƒ¼ãƒãƒ£ãƒ³ãƒ€ã‚¤ã‚¸ãƒ³ã‚°": 'border-teal-500',
    "ã‚¹ãƒˆã‚¢ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³": 'border-amber-500',
    "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°": 'border-rose-500',
    "è²©å£²ãƒ»çµŒå–¶ç®¡ç†": 'border-sky-500',
    "ç·åˆ50å•æ¨¡è©¦": 'border-purple-500'
};

const displayOrder = [
    "å°å£²æ¥­ã®é¡å‹ (é¸æŠå¼)", "å°å£²æ¥­ã®é¡å‹ (è¨˜è¿°å¼)",
    "ãƒãƒ¼ãƒãƒ£ãƒ³ãƒ€ã‚¤ã‚¸ãƒ³ã‚° (é¸æŠå¼)", "ãƒãƒ¼ãƒãƒ£ãƒ³ãƒ€ã‚¤ã‚¸ãƒ³ã‚° (è¨˜è¿°å¼)",
    "ã‚¹ãƒˆã‚¢ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (é¸æŠå¼)", "ã‚¹ãƒˆã‚¢ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (è¨˜è¿°å¼)",
    "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° (é¸æŠå¼)", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° (è¨˜è¿°å¼)",
    "è²©å£²ãƒ»çµŒå–¶ç®¡ç† (é¸æŠå¼)", "è²©å£²ãƒ»çµŒå–¶ç®¡ç† (è¨˜è¿°å¼)"
];

let currentList = [];
let currentIndex = 0;
let correctCount = 0;
let incorrectCount = 0;
let incorrectQuestions = [];
let currentQuizTitle = '';

const app = document.getElementById("app-container");

function initMenu() {
    app.innerHTML = `
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">è²©å£²å£«1ç´š ãƒãƒ¼ãƒãƒ£ãƒ«æ¨¡è©¦</h1>
            <p class="mt-2 text-slate-600">ã‚«ãƒ†ã‚´ãƒªã¾ãŸã¯ç·åˆæ¨¡è©¦ã‚’é¸æŠã—ã¦å­¦ç¿’ã‚’é–‹å§‹</p>
        </header>
        <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    `;

    const grid = document.getElementById("menu-grid");

    const comprehensiveBtn = document.createElement("button");
    comprehensiveBtn.className = "btn-comprehensive p-6 rounded-xl shadow-lg hover:shadow-xl text-left transition-all col-span-1 md:col-span-2 flex items-center justify-between";
    comprehensiveBtn.innerHTML = `
        <div>
            <h2 class="text-xl font-bold mb-1">ç·åˆ50å•æ¨¡è©¦ ğŸš€</h2>
            <p class="text-sm text-white/90">å…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§50å•ã‚’å‡ºé¡Œ</p>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white/80" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
        </svg>
    `;
    comprehensiveBtn.onclick = () => startComprehensiveQuiz();
    grid.appendChild(comprehensiveBtn);

    if (incorrectQuestions.length > 0) {
        const retryBtn = document.createElement("button");
        retryBtn.className = "btn-retry p-6 rounded-xl shadow hover:shadow-lg text-left transition-all col-span-1 md:col-span-2";
        retryBtn.innerHTML = `
            <h2 class="text-lg font-bold mb-2">å‰å›ã®é–“é•ã„ã«å†æŒ‘æˆ¦ ğŸ’ª</h2>
            <p class="text-sm text-white/90">å•é¡Œæ•°ï¼š${incorrectQuestions.length}</p>
        `;
        retryBtn.onclick = () => startRetryQuiz();
        grid.appendChild(retryBtn);
    }

    displayOrder.forEach(key => {
        if (!quizDataOriginal[key] || quizDataOriginal[key].length === 0) return;
        const baseGenreName = key.split(' ')[0];
        const colorClass = genreColors[baseGenreName] || 'border-slate-300';

        const btn = document.createElement("button");
        btn.className = `bg-white p-6 rounded-xl shadow hover:shadow-lg text-left transition-all border-t-8 ${colorClass}`;
        btn.innerHTML = `
            <h2 class="text-lg font-bold mb-2 text-slate-800">${key}</h2>
            <p class="text-sm text-slate-600">å•é¡Œæ•°ï¼š${quizDataOriginal[key].length}</p>
        `;
        btn.onclick = () => startQuiz(key);
        grid.appendChild(btn);
    });
}

function startQuiz(key) {
    currentList = JSON.parse(JSON.stringify(quizDataOriginal[key]));
    currentIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    currentQuizTitle = key;
    renderQuizPage();
}

function startComprehensiveQuiz() {
    let allQuestions = [];
    for (const key in quizDataOriginal) {
        if (quizDataOriginal[key] && quizDataOriginal[key].length > 0) {
            const baseGenreName = key.split(' ')[0];
            const questionsWithGenre = quizDataOriginal[key].map(q => ({...q, genre: baseGenreName}));
            allQuestions = allQuestions.concat(questionsWithGenre);
        }
    }
    for (let i = allQuestions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]];
    }
    currentList = JSON.parse(JSON.stringify(allQuestions.slice(0, 50)));
    currentIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    incorrectQuestions = [];
    currentQuizTitle = "ç·åˆ50å•æ¨¡è©¦";
    renderQuizPage();
}

function startRetryQuiz() {
    if (incorrectQuestions.length === 0) {
        console.log("å†æŒ‘æˆ¦ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }
    currentList = JSON.parse(JSON.stringify(incorrectQuestions));
    currentIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    incorrectQuestions = [];
    currentQuizTitle = "é–“é•ãˆãŸå•é¡Œã®å†æŒ‘æˆ¦";
    renderQuizPage();
}

function renderQuizPage() {
    const title = currentQuizTitle;
    const data = currentList[currentIndex];
    const baseGenreName = data.genre || title.split(' ')[0];
    const colorClass = genreColors[baseGenreName] ? genreColors[baseGenreName].replace('border-', 'bg-').replace('-500', '-100') : 'bg-slate-100';
    const textColorClass = genreColors[baseGenreName] ? genreColors[baseGenreName].replace('border-', 'text-').replace('-500', '-800') : 'text-slate-800';

    app.innerHTML = `
        <header class="mb-6 border-b pb-4">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <h2 class="text-xl md:text-2xl font-bold text-slate-900">${title}</h2>
                <div class="flex items-center space-x-2 md:space-x-4">
                     <span id="correct-count" class="px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full text-sm font-semibold">
                        æ­£è§£: ${correctCount}
                    </span>
                    <span class="px-3 py-1 bg-slate-200 text-slate-700 rounded-full text-sm font-semibold">
                        ${currentIndex + 1} / ${currentList.length}
                    </span>
                </div>
            </div>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-md">
             <div class="flex justify-between items-center mb-4">
                <span class="px-2 py-1 text-xs font-semibold text-white rounded-md ${data.type === "multiple-choice" ? "bg-blue-600" : "bg-green-600"}">
                    ${data.type === "multiple-choice" ? "é¸æŠå¼" : "è¨˜è¿°å¼"}
                </span>
                ${data.genre ? `<span class="px-2 py-1 text-xs font-semibold rounded-md ${colorClass} ${textColorClass}">${data.genre}</span>` : ''}
            </div>
            <p class="text-lg leading-relaxed mt-4 whitespace-pre-wrap">${data.question}</p>
            <div id="answer-area" class="mt-6 space-y-3"></div>
        </div>
        <div id="feedback" class="mt-2 min-h-[60px]"></div>
        <footer class="mt-4 flex justify-between items-center">
            <button id="back-to-menu" class="w-auto px-6 py-2 bg-slate-300 hover:bg-slate-400 text-slate-800 rounded-lg transition-colors">çµ‚äº†</button>
            <div class="flex items-center gap-2">
                <button id="prev-question" class="w-auto px-6 py-2 bg-slate-500 hover:bg-slate-600 text-white rounded-lg transition-colors">æˆ»ã‚‹</button>
                <button id="next-question" class="w-auto px-8 py-3 bg-blue-600 text-white rounded-lg">æ¬¡ã¸</button>
            </div>
        </footer>`;

    const answerArea = document.getElementById("answer-area");
    const nextButton = document.getElementById('next-question');
    const prevButton = document.getElementById('prev-question');

    document.getElementById("back-to-menu").onclick = initMenu;
    nextButton.onclick = handleNextQuestion;
    prevButton.onclick = handlePrevQuestion;

    prevButton.disabled = currentIndex === 0;
    prevButton.classList.toggle('opacity-50', currentIndex === 0);

    if (data.type === "multiple-choice") {
        const shuffledOptions = data.shuffledOptions || [...data.options].sort(() => Math.random() - 0.5);
        if (!data.shuffledOptions) data.shuffledOptions = shuffledOptions;

        shuffledOptions.forEach(optionText => {
            const btn = document.createElement("button");
            btn.className = "quiz-option w-full text-left p-4 border-2 border-slate-200 rounded-lg hover:bg-slate-50 hover:border-blue-400";
            btn.textContent = optionText;
            btn.onclick = () => checkAnswer(optionText);
            answerArea.appendChild(btn);
        });
    } else {
        answerArea.innerHTML = `
            <input id="fill-in-answer" type="text" class="w-full p-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        `;
        const input = document.getElementById("fill-in-answer");
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Tab' && !event.shiftKey) {
                event.preventDefault(); 
                nextButton.focus(); 
            }
        });
    }

    if (data.isChecked) {
        restoreAnsweredState(data);
    } else {
        nextButton.disabled = data.type === 'multiple-choice';
        nextButton.classList.toggle('opacity-50', data.type === 'multiple-choice');
    }
}

function restoreAnsweredState(data) {
    const isCorrect = data.userAnswer.trim() === data.answer.trim();
    const feedback = document.getElementById("feedback");
    const nextButton = document.getElementById('next-question');

    feedback.innerHTML = `
        <div class="p-4 rounded-lg explanation-box ${isCorrect ? 'bg-emerald-50 border-l-4 border-emerald-500' : 'bg-red-50 border-l-4 border-red-500'}">
            <h3 class="font-bold ${isCorrect ? 'text-emerald-700' : 'text-red-700'}">${isCorrect ? "æ­£è§£ï¼" : `ä¸æ­£è§£â€¦ (æ­£è§£: ${data.answer})`}</h3>
            <p class="mt-1 text-sm text-slate-600">${data.explanation || ""}</p>
        </div>
    `;

    if (data.type === "multiple-choice") {
        const optionButtons = document.querySelectorAll(".quiz-option");
        optionButtons.forEach(btn => {
            btn.disabled = true;
            if (btn.textContent.trim() === data.answer.trim()) {
                btn.classList.add("correct");
            } else if (btn.textContent.trim() === data.userAnswer.trim()){
                btn.classList.add("incorrect");
            }
        });
    } else {
        const input = document.getElementById("fill-in-answer");
        input.value = data.userAnswer;
        input.disabled = true;
    }

    nextButton.disabled = false;
    nextButton.classList.remove('opacity-50');
}

function checkAnswer(userAnswer) {
    const data = currentList[currentIndex];
    if (data.isChecked) return;

    data.userAnswer = userAnswer;
    data.isChecked = true;

    const isCorrect = userAnswer.trim() === data.answer.trim();
    if (isCorrect) {
        correctCount++;
    } else {
        incorrectCount++;
        if (!incorrectQuestions.some(q => q.question === data.question)) {
             incorrectQuestions.push(JSON.parse(JSON.stringify(data)));
        }
    }
    
    document.getElementById('correct-count').textContent = `æ­£è§£: ${correctCount}`;
    restoreAnsweredState(data);
}

function handleNextQuestion() {
    const data = currentList[currentIndex];
    if (data.isChecked) {
        goToNextOrShowResult();
    } else {
        if (data.type === "fill-in-the-blank") {
            const userAnswer = document.getElementById("fill-in-answer").value;
            if (userAnswer.trim() === "") {
               const feedback = document.getElementById("feedback");
               feedback.innerHTML = `<div class="p-4 rounded-lg explanation-box bg-yellow-50 border-l-4 border-yellow-500"><h3 class="font-bold text-yellow-700">è§£ç­”ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3></div>`;
               return;
            }
            checkAnswer(userAnswer);
        }
    }
}

// â˜…ä¿®æ­£ç‚¹: ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç°¡æ½”ã«ã—ã€ç¢ºå®Ÿã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
function handlePrevQuestion() {
    if (currentIndex > 0) {
        // å‰ã®å•é¡Œã«æˆ»ã‚‹
        currentIndex--;

        // æˆ»ã£ãŸå…ˆã®ã‚¯ã‚¤ã‚ºã®çŠ¶æ…‹ï¼ˆè§£ç­”å±¥æ­´ã€æ­£èª¤ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
        const questionToReset = currentList[currentIndex];
        if (questionToReset.isChecked) {
            const wasCorrect = questionToReset.userAnswer.trim() === questionToReset.answer.trim();
            if (wasCorrect) {
                correctCount--;
            } else {
                incorrectCount--;
                const incorrectIndex = incorrectQuestions.findIndex(q => q.question === questionToReset.question);
                if (incorrectIndex > -1) {
                    incorrectQuestions.splice(incorrectIndex, 1);
                }
            }
            // isCheckedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãªã©ã‚’å‰Šé™¤ã—ã¦ã€æœªè§£ç­”ã®çŠ¶æ…‹ã«æˆ»ã™
            delete questionToReset.isChecked;
            delete questionToReset.userAnswer;
            if (questionToReset.type === 'multiple-choice') {
                delete questionToReset.shuffledOptions;
            }
        }
        
        // ãƒšãƒ¼ã‚¸ã‚’å†æç”»
        renderQuizPage();
    }
}


function goToNextOrShowResult() {
    currentIndex++;
    if (currentIndex < currentList.length) {
        renderQuizPage();
    } else {
        showResult();
    }
}

function showResult() {
    const total = currentList.length;
    const percent = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    const title = currentQuizTitle;

    let resultHTML = `
        <div class="text-center bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold mb-2 text-slate-900">çµæœç™ºè¡¨</h2>
            <p class="text-lg text-slate-600 mb-4">ã€Œ${title}ã€ã®çµæœ</p>
            <div class="my-6">
                <p class="text-5xl font-bold text-blue-600">${percent}<span class="text-2xl text-slate-500">%</span></p>
                <p class="text-xl mt-2 text-slate-700">${total} å•ä¸­ ${correctCount} å•æ­£è§£</p>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" onclick="initMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
    `;
    if (incorrectCount > 0) {
        resultHTML += `<button class="w-full md:w-auto px-8 py-3 btn-retry hover:bg-orange-600 text-white rounded-lg transition-colors" onclick="startRetryQuiz()">é–“é•ãˆãŸå•é¡Œã‚’å†æŒ‘æˆ¦ (${incorrectCount}å•)</button>`;
    }
    resultHTML += `
            </div>
        </div>
    `;
    app.innerHTML = resultHTML;
}

// åˆæœŸåŒ–
window.onload = function() {
    initMenu();
};
</script>
</body>
</html>
