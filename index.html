<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>販売士1級バーチャル模試 – 問題データ埋込版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
    .quiz-option { transition: all .2s ease-in-out; }
    .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
    .correct { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46; }
    .incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b; }
    .explanation-box { animation: fadeIn .5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-retry { background-color: #f97316; color: white; }
    .btn-retry:hover { background-color: #ea580c; }
    .btn-comprehensive { background: linear-gradient(to right, #6d28d9, #4f46e5); color: white; }
    .btn-comprehensive:hover { background: linear-gradient(to right, #5b21b6, #4338ca); }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

<div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8"></div>

<script>
// --- 問題データ ---
// このセクションに問題データを入力してください
const quizDataOriginal = {
 "販売・経営管理 (選択式)": [
    { "type": "multiple-choice", "question": "問題解決のための教育方法の一つである [ ] とは多くの職場で起こりうるような案件を的確かつ迅速に精度高く処理することができるのかを測るシミュレーション演習のことである。", "options": ["ケーススタディメソッド", "プロジェクト法", "インバスケット法", "マネジメントゲーム"], "answer": "インバスケット法", "explanation": "インバスケット法は、受講者を架空の役職者に設定し、未処理の案件が溜まった書類箱（インバスケット）を渡して、制限時間内に案件を処理させる演習です。優先順位付け、情報分析、意思決定、指示・伝達能力など、管理者に求められる総合的な問題解決能力を評価・育成するために用いられます。" },
    { "type": "multiple-choice", "question": "ファイナンスリース取引は、リース資産の所有権が借り手に移転するかどうかで、[ ] 取引と所有権移転外ファイナンスリース取引に分類される。", "options": ["レンタル契約", "ソフトウェアリース", "オペレーティングリース", "所有権移転ファイナンスリース"], "answer": "所有権移転ファイナンスリース", "explanation": "ファイナンスリースは、中途解約不能で、物件から得られる利益を実質的に享受し、維持管理コストも負担する、売買に近い取引です。その中で、リース期間満了後に所有権が移転する契約を「所有権移転ファイナンスリース」、移転しないものを「所有権移転外ファイナンスリース」と区別します。" },
  ],
  "販売・経営管理 (記述式)": [
    { "type": "fill-in-the-blank", "question": "従業員管理職能の実行プロセスはJ.H.ファヨールによると次の順となっている。①計画、②[]、③動機づけ、④指令、⑤調整、⑥統制", "answer": "組織化", "explanation": "経営管理の父と呼ばれるファヨールは、管理活動を①計画(Plan)→②組織化(Organize)→③指令(Command)→④調整(Coordinate)→⑤統制(Control)の5つのプロセスに分類しました。動機づけは、現代のマネジメント論で指令の中に含まれる要素として重要視されています。" },
    { "type": "fill-in-the-blank", "question": "日本の組織運営の特質である [] と集団主義を基盤として経営組織内で発達してきたのは小集団活動である。", "answer": "ボトムアップ方式", "explanation": "ボトムアップ方式とは、現場の従業員からの提案や意見を吸い上げて経営層の意思決定に反映させる管理方式です。QCサークルに代表される小集団活動は、このボトムアップ方式と、集団の和を重んじる日本的な組織文化を背景に発展しました。" }
  ],
    "小売業の類型 (選択式)": [],
    "小売業の類型 (記述式)": [],
    "マーチャンダイジング (選択式)": [],
    "マーチャンダイジング (記述式)": [],
    "ストアオペレーション (選択式)": [],
    "ストアオペレーション (記述式)": [],
    "マーケティング (選択式)": [],
    "マーケティング (記述式)": []
};
// -------------------- ここまで --------------------

// 以降はアプリ本体のスクリプト
const genreColors = {
    "小売業の類型": 'border-indigo-500',
    "マーチャンダイジング": 'border-teal-500',
    "ストアオペレーション": 'border-amber-500',
    "マーケティング": 'border-rose-500',
    "販売・経営管理": 'border-sky-500',
    "総合50問模試": 'border-purple-500'
};

const displayOrder = [
    "小売業の類型 (選択式)", "小売業の類型 (記述式)",
    "マーチャンダイジング (選択式)", "マーチャンダイジング (記述式)",
    "ストアオペレーション (選択式)", "ストアオペレーション (記述式)",
    "マーケティング (選択式)", "マーケティング (記述式)",
    "販売・経営管理 (選択式)", "販売・経営管理 (記述式)"
];

let currentList = [];
let currentIndex = 0;
let correctCount = 0;
let incorrectCount = 0;
let incorrectQuestions = [];
let currentQuizTitle = '';

const app = document.getElementById("app-container");

function initMenu() {
    app.innerHTML = `
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">販売士1級 バーチャル模試</h1>
            <p class="mt-2 text-slate-600">カテゴリまたは総合模試を選択して学習を開始</p>
        </header>
        <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    `;

    const grid = document.getElementById("menu-grid");

    const comprehensiveBtn = document.createElement("button");
    comprehensiveBtn.className = "btn-comprehensive p-6 rounded-xl shadow-lg hover:shadow-xl text-left transition-all col-span-1 md:col-span-2 flex items-center justify-between";
    comprehensiveBtn.innerHTML = `
        <div>
            <h2 class="text-xl font-bold mb-1">総合50問模試 🚀</h2>
            <p class="text-sm text-white/90">全カテゴリからランダムで50問を出題</p>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white/80" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
        </svg>
    `;
    comprehensiveBtn.onclick = () => startComprehensiveQuiz();
    grid.appendChild(comprehensiveBtn);

    if (incorrectQuestions.length > 0) {
        const retryBtn = document.createElement("button");
        retryBtn.className = "btn-retry p-6 rounded-xl shadow hover:shadow-lg text-left transition-all col-span-1 md:col-span-2";
        retryBtn.innerHTML = `
            <h2 class="text-lg font-bold mb-2">前回の間違いに再挑戦 💪</h2>
            <p class="text-sm text-white/90">問題数：${incorrectQuestions.length}</p>
        `;
        retryBtn.onclick = () => startRetryQuiz();
        grid.appendChild(retryBtn);
    }

    displayOrder.forEach(key => {
        if (!quizDataOriginal[key] || quizDataOriginal[key].length === 0) return;
        const baseGenreName = key.split(' ')[0];
        const colorClass = genreColors[baseGenreName] || 'border-slate-300';

        const btn = document.createElement("button");
        btn.className = `bg-white p-6 rounded-xl shadow hover:shadow-lg text-left transition-all border-t-8 ${colorClass}`;
        btn.innerHTML = `
            <h2 class="text-lg font-bold mb-2 text-slate-800">${key}</h2>
            <p class="text-sm text-slate-600">問題数：${quizDataOriginal[key].length}</p>
        `;
        btn.onclick = () => startQuiz(key);
        grid.appendChild(btn);
    });
}

function startQuiz(key) {
    currentList = JSON.parse(JSON.stringify(quizDataOriginal[key]));
    currentIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    currentQuizTitle = key;
    renderQuizPage();
}

function startComprehensiveQuiz() {
    let allQuestions = [];
    for (const key in quizDataOriginal) {
        if (quizDataOriginal[key] && quizDataOriginal[key].length > 0) {
            const baseGenreName = key.split(' ')[0];
            const questionsWithGenre = quizDataOriginal[key].map(q => ({...q, genre: baseGenreName}));
            allQuestions = allQuestions.concat(questionsWithGenre);
        }
    }
    for (let i = allQuestions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]];
    }
    currentList = JSON.parse(JSON.stringify(allQuestions.slice(0, 50)));
    currentIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    incorrectQuestions = [];
    currentQuizTitle = "総合50問模試";
    renderQuizPage();
}

function startRetryQuiz() {
    if (incorrectQuestions.length === 0) {
        console.log("再挑戦する問題がありません。");
        return;
    }
    currentList = JSON.parse(JSON.stringify(incorrectQuestions));
    currentIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    incorrectQuestions = [];
    currentQuizTitle = "間違えた問題の再挑戦";
    renderQuizPage();
}

function renderQuizPage() {
    const title = currentQuizTitle;
    const data = currentList[currentIndex];
    const baseGenreName = data.genre || title.split(' ')[0];
    const colorClass = genreColors[baseGenreName] ? genreColors[baseGenreName].replace('border-', 'bg-').replace('-500', '-100') : 'bg-slate-100';
    const textColorClass = genreColors[baseGenreName] ? genreColors[baseGenreName].replace('border-', 'text-').replace('-500', '-800') : 'text-slate-800';

    app.innerHTML = `
        <header class="mb-6 border-b pb-4">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <h2 class="text-xl md:text-2xl font-bold text-slate-900">${title}</h2>
                <div class="flex items-center space-x-2 md:space-x-4">
                     <span id="correct-count" class="px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full text-sm font-semibold">
                        正解: ${correctCount}
                    </span>
                    <span class="px-3 py-1 bg-slate-200 text-slate-700 rounded-full text-sm font-semibold">
                        ${currentIndex + 1} / ${currentList.length}
                    </span>
                </div>
            </div>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-md">
             <div class="flex justify-between items-center mb-4">
                <span class="px-2 py-1 text-xs font-semibold text-white rounded-md ${data.type === "multiple-choice" ? "bg-blue-600" : "bg-green-600"}">
                    ${data.type === "multiple-choice" ? "選択式" : "記述式"}
                </span>
                ${data.genre ? `<span class="px-2 py-1 text-xs font-semibold rounded-md ${colorClass} ${textColorClass}">${data.genre}</span>` : ''}
            </div>
            <p class="text-lg leading-relaxed mt-4 whitespace-pre-wrap">${data.question}</p>
            <div id="answer-area" class="mt-6 space-y-3"></div>
        </div>
        <div id="feedback" class="mt-2 min-h-[60px]"></div>
        <footer class="mt-4 flex justify-between items-center">
            <button id="back-to-menu" class="w-auto px-6 py-2 bg-slate-300 hover:bg-slate-400 text-slate-800 rounded-lg transition-colors">終了</button>
            <div class="flex items-center gap-2">
                <button id="prev-question" class="w-auto px-6 py-2 bg-slate-500 hover:bg-slate-600 text-white rounded-lg transition-colors">戻る</button>
                <button id="next-question" class="w-auto px-8 py-3 bg-blue-600 text-white rounded-lg">次へ</button>
            </div>
        </footer>`;

    const answerArea = document.getElementById("answer-area");
    const nextButton = document.getElementById('next-question');
    const prevButton = document.getElementById('prev-question');

    document.getElementById("back-to-menu").onclick = initMenu;
    nextButton.onclick = handleNextQuestion;
    prevButton.onclick = handlePrevQuestion;

    prevButton.disabled = currentIndex === 0;
    prevButton.classList.toggle('opacity-50', currentIndex === 0);

    if (data.type === "multiple-choice") {
        const shuffledOptions = data.shuffledOptions || [...data.options].sort(() => Math.random() - 0.5);
        if (!data.shuffledOptions) data.shuffledOptions = shuffledOptions;

        shuffledOptions.forEach(optionText => {
            const btn = document.createElement("button");
            btn.className = "quiz-option w-full text-left p-4 border-2 border-slate-200 rounded-lg hover:bg-slate-50 hover:border-blue-400";
            btn.textContent = optionText;
            btn.onclick = () => checkAnswer(optionText);
            answerArea.appendChild(btn);
        });
    } else {
        answerArea.innerHTML = `
            <input id="fill-in-answer" type="text" class="w-full p-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="解答を入力してください">
        `;
        const input = document.getElementById("fill-in-answer");
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Tab' && !event.shiftKey) {
                event.preventDefault(); 
                nextButton.focus(); 
            }
        });
    }

    if (data.isChecked) {
        restoreAnsweredState(data);
    } else {
        nextButton.disabled = data.type === 'multiple-choice';
        nextButton.classList.toggle('opacity-50', data.type === 'multiple-choice');
    }
}

function restoreAnsweredState(data) {
    const isCorrect = data.userAnswer.trim() === data.answer.trim();
    const feedback = document.getElementById("feedback");
    const nextButton = document.getElementById('next-question');

    feedback.innerHTML = `
        <div class="p-4 rounded-lg explanation-box ${isCorrect ? 'bg-emerald-50 border-l-4 border-emerald-500' : 'bg-red-50 border-l-4 border-red-500'}">
            <h3 class="font-bold ${isCorrect ? 'text-emerald-700' : 'text-red-700'}">${isCorrect ? "正解！" : `不正解… (正解: ${data.answer})`}</h3>
            <p class="mt-1 text-sm text-slate-600">${data.explanation || ""}</p>
        </div>
    `;

    if (data.type === "multiple-choice") {
        const optionButtons = document.querySelectorAll(".quiz-option");
        optionButtons.forEach(btn => {
            btn.disabled = true;
            if (btn.textContent.trim() === data.answer.trim()) {
                btn.classList.add("correct");
            } else if (btn.textContent.trim() === data.userAnswer.trim()){
                btn.classList.add("incorrect");
            }
        });
    } else {
        const input = document.getElementById("fill-in-answer");
        input.value = data.userAnswer;
        input.disabled = true;
    }

    nextButton.disabled = false;
    nextButton.classList.remove('opacity-50');
}

function checkAnswer(userAnswer) {
    const data = currentList[currentIndex];
    if (data.isChecked) return;

    data.userAnswer = userAnswer;
    data.isChecked = true;

    const isCorrect = userAnswer.trim() === data.answer.trim();
    if (isCorrect) {
        correctCount++;
    } else {
        incorrectCount++;
        if (!incorrectQuestions.some(q => q.question === data.question)) {
             incorrectQuestions.push(JSON.parse(JSON.stringify(data)));
        }
    }
    
    document.getElementById('correct-count').textContent = `正解: ${correctCount}`;
    restoreAnsweredState(data);
}

function handleNextQuestion() {
    const data = currentList[currentIndex];
    if (data.isChecked) {
        goToNextOrShowResult();
    } else {
        if (data.type === "fill-in-the-blank") {
            const userAnswer = document.getElementById("fill-in-answer").value;
            if (userAnswer.trim() === "") {
               const feedback = document.getElementById("feedback");
               feedback.innerHTML = `<div class="p-4 rounded-lg explanation-box bg-yellow-50 border-l-4 border-yellow-500"><h3 class="font-bold text-yellow-700">解答が入力されていません</h3></div>`;
               return;
            }
            checkAnswer(userAnswer);
        }
    }
}

// ★修正点: 「戻る」ボタンのロジックを簡潔にし、確実に動作するように修正
function handlePrevQuestion() {
    if (currentIndex > 0) {
        // 前の問題に戻る
        currentIndex--;

        // 戻った先のクイズの状態（解答履歴、正誤カウント）をリセットする
        const questionToReset = currentList[currentIndex];
        if (questionToReset.isChecked) {
            const wasCorrect = questionToReset.userAnswer.trim() === questionToReset.answer.trim();
            if (wasCorrect) {
                correctCount--;
            } else {
                incorrectCount--;
                const incorrectIndex = incorrectQuestions.findIndex(q => q.question === questionToReset.question);
                if (incorrectIndex > -1) {
                    incorrectQuestions.splice(incorrectIndex, 1);
                }
            }
            // isCheckedプロパティなどを削除して、未解答の状態に戻す
            delete questionToReset.isChecked;
            delete questionToReset.userAnswer;
            if (questionToReset.type === 'multiple-choice') {
                delete questionToReset.shuffledOptions;
            }
        }
        
        // ページを再描画
        renderQuizPage();
    }
}


function goToNextOrShowResult() {
    currentIndex++;
    if (currentIndex < currentList.length) {
        renderQuizPage();
    } else {
        showResult();
    }
}

function showResult() {
    const total = currentList.length;
    const percent = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    const title = currentQuizTitle;

    let resultHTML = `
        <div class="text-center bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold mb-2 text-slate-900">結果発表</h2>
            <p class="text-lg text-slate-600 mb-4">「${title}」の結果</p>
            <div class="my-6">
                <p class="text-5xl font-bold text-blue-600">${percent}<span class="text-2xl text-slate-500">%</span></p>
                <p class="text-xl mt-2 text-slate-700">${total} 問中 ${correctCount} 問正解</p>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" onclick="initMenu()">メニューへ戻る</button>
    `;
    if (incorrectCount > 0) {
        resultHTML += `<button class="w-full md:w-auto px-8 py-3 btn-retry hover:bg-orange-600 text-white rounded-lg transition-colors" onclick="startRetryQuiz()">間違えた問題を再挑戦 (${incorrectCount}問)</button>`;
    }
    resultHTML += `
            </div>
        </div>
    `;
    app.innerHTML = resultHTML;
}

// 初期化
window.onload = function() {
    initMenu();
};
</script>
</body>
</html>
